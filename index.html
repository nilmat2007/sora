<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sora AI Tools Â· kie.ai</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --card: #16161f;
    --border: #2a2a3a;
    --accent: #7c3aed;
    --accent2: #06b6d4;
    --success: #10b981;
    --error: #ef4444;
    --warn: #f59e0b;
    --text: #e8e8f0;
    --muted: #6b6b80;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% -20%, rgba(124,58,237,.15) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 110%, rgba(6,182,212,.1) 0%, transparent 60%);
    pointer-events: none; z-index: 0;
  }

  .wrap {
    position: relative; z-index: 1;
    max-width: 960px; margin: 0 auto;
    padding: 48px 24px 100px;
  }

  /* â”€â”€ Header â”€â”€ */
  header { text-align: center; margin-bottom: 48px; }

  .badge {
    display: inline-block;
    background: linear-gradient(135deg, rgba(124,58,237,.3), rgba(6,182,212,.2));
    border: 1px solid rgba(124,58,237,.4);
    border-radius: 99px; padding: 4px 14px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px; letter-spacing: .08em; color: var(--accent2);
    margin-bottom: 16px;
  }

  h1 {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 800; letter-spacing: -.02em; line-height: 1.1;
    background: linear-gradient(135deg, #fff 0%, var(--accent2) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text; margin-bottom: 12px;
  }

  .subtitle { color: var(--muted); font-size: 14px; font-family: 'JetBrains Mono', monospace; }

  /* â”€â”€ Tab switcher â”€â”€ */
  .tabs {
    display: flex; gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px; padding: 6px;
    margin-bottom: 24px;
  }

  .tab {
    flex: 1; padding: 11px 8px;
    background: transparent; border: none; border-radius: 10px;
    color: var(--muted); font-family: 'Syne', sans-serif;
    font-size: 13px; font-weight: 700; cursor: pointer;
    transition: all .2s; text-align: center;
  }

  .tab:hover { color: var(--text); background: rgba(255,255,255,.04); }

  .tab.active {
    background: linear-gradient(135deg, var(--accent), #9333ea);
    color: #fff;
    box-shadow: 0 2px 12px rgba(124,58,237,.4);
  }

  /* â”€â”€ Panel â”€â”€ */
  .panel {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px; margin-bottom: 20px;
  }

  .panel-title {
    font-size: 12px; font-weight: 700;
    letter-spacing: .1em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }

  .panel-title::before {
    content: ''; width: 6px; height: 6px;
    background: var(--accent); border-radius: 50%;
    box-shadow: 0 0 8px var(--accent);
  }

  /* â”€â”€ Inputs â”€â”€ */
  label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 7px; }

  input[type="text"], textarea, select {
    width: 100%;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 16px;
    color: var(--text); font-family: 'JetBrains Mono', monospace;
    font-size: 13px; outline: none; transition: border-color .2s;
  }

  input[type="text"]:focus, textarea:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124,58,237,.15);
  }

  input::placeholder, textarea::placeholder { color: var(--muted); opacity: .6; }

  textarea { resize: vertical; line-height: 1.6; }
  select { cursor: pointer; }

  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .mt { margin-top: 16px; }

  .hint {
    font-size: 11px; color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    margin-top: 7px; line-height: 1.7;
  }

  .hint code {
    background: rgba(124,58,237,.15); border: 1px solid rgba(124,58,237,.25);
    border-radius: 4px; padding: 1px 6px; color: var(--accent2);
  }

  /* â”€â”€ Image upload area â”€â”€ */
  .upload-zone {
    border: 2px dashed var(--border); border-radius: 12px;
    padding: 28px 20px; text-align: center; cursor: pointer;
    transition: all .2s; position: relative; overflow: hidden;
  }

  .upload-zone:hover, .upload-zone.drag { border-color: var(--accent); background: rgba(124,58,237,.05); }

  .upload-zone input[type="file"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }

  .upload-icon { font-size: 32px; margin-bottom: 10px; }
  .upload-text { font-size: 13px; color: var(--muted); }
  .upload-text span { color: var(--accent2); font-weight: 700; }

  .preview-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }

  .preview-item {
    position: relative; width: 80px; height: 80px;
    border-radius: 8px; overflow: hidden;
    border: 1px solid var(--border);
  }

  .preview-item img { width: 100%; height: 100%; object-fit: cover; }

  .preview-item .rm {
    position: absolute; top: 2px; right: 2px;
    background: rgba(0,0,0,.7); border: none; border-radius: 50%;
    width: 18px; height: 18px; color: #fff; font-size: 11px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }

  /* â”€â”€ Action button â”€â”€ */
  .btn-primary {
    width: 100%; padding: 15px;
    background: linear-gradient(135deg, var(--accent), #9333ea);
    border: none; border-radius: 12px; color: #fff;
    font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700;
    letter-spacing: .04em; cursor: pointer; transition: all .2s;
    box-shadow: 0 4px 20px rgba(124,58,237,.3); margin-top: 20px;
  }

  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 28px rgba(124,58,237,.45); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: .5; cursor: not-allowed; transform: none; }

  /* â”€â”€ Results â”€â”€ */
  #results-section { display: none; }

  .section-title {
    font-size: 14px; font-weight: 700; color: var(--text);
    display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
  }

  .section-title::before {
    content: ''; width: 6px; height: 6px;
    background: var(--success); border-radius: 50%;
    box-shadow: 0 0 8px var(--success);
  }

  .stats-bar {
    display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;
    font-family: 'JetBrains Mono', monospace; font-size: 12px;
    padding: 12px 18px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 10px;
  }

  .stat { color: var(--muted); }
  .stat span { font-weight: 700; color: var(--text); }
  .stat.s-done span { color: var(--success); }
  .stat.s-run span  { color: var(--warn); }
  .stat.s-fail span { color: var(--error); }

  .job-item {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px 18px; margin-bottom: 12px;
    display: flex; align-items: flex-start; gap: 14px;
    animation: slideIn .3s ease; transition: border-color .4s, background .4s;
  }

  .job-item.success { border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.04); }
  .job-item.fail    { border-color: rgba(239,68,68,.25); }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .job-num {
    min-width: 32px; height: 32px;
    background: rgba(124,58,237,.2); border: 1px solid rgba(124,58,237,.3);
    border-radius: 8px; display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-family: 'JetBrains Mono', monospace;
    color: var(--accent2); font-weight: 700; flex-shrink: 0; margin-top: 2px;
  }

  .job-info { flex: 1; min-width: 0; }

  .job-name {
    font-size: 15px; font-weight: 700; color: var(--text);
    margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  .job-sub {
    font-size: 11px; font-family: 'JetBrains Mono', monospace;
    color: var(--muted); white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; margin-bottom: 8px;
  }

  .job-status {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 500;
  }

  .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .dot.waiting { background: var(--warn); box-shadow: 0 0 6px var(--warn); animation: pulse 1.5s infinite; }
  .dot.success { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .dot.fail    { background: var(--error); box-shadow: 0 0 6px var(--error); }
  .dot.queued  { background: var(--muted); }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.35; } }

  .task-id { font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 5px; opacity: .6; }
  .error-msg { font-size: 11px; color: var(--error); margin-top: 6px; font-family: 'JetBrains Mono', monospace; }

  .btn-download {
    display: inline-flex; align-items: center; gap: 7px;
    margin-top: 10px; padding: 8px 14px;
    background: rgba(16,185,129,.15); border: 1px solid rgba(16,185,129,.35);
    border-radius: 8px; color: var(--success);
    font-size: 13px; font-family: 'Syne', sans-serif; font-weight: 700;
    cursor: pointer; transition: all .2s;
  }

  .btn-download:hover { background: rgba(16,185,129,.28); transform: translateY(-1px); }
  .btn-download:disabled { opacity: .5; cursor: wait; transform: none; }

  .dl-progress { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--warn); margin-top: 6px; }

  /* â”€â”€ Tab content visibility â”€â”€ */
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* â”€â”€ Toggle (remove_watermark) â”€â”€ */
  .toggle-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 0;
  }

  .toggle-label { font-size: 13px; color: var(--muted); }

  .toggle {
    position: relative; width: 44px; height: 24px;
  }

  .toggle input { opacity: 0; width: 0; height: 0; }

  .slider {
    position: absolute; inset: 0; background: var(--border);
    border-radius: 99px; cursor: pointer; transition: .3s;
  }

  .slider::before {
    content: ''; position: absolute;
    width: 18px; height: 18px; left: 3px; bottom: 3px;
    background: #fff; border-radius: 50%; transition: .3s;
  }

  input:checked + .slider { background: var(--success); }
  input:checked + .slider::before { transform: translateX(20px); }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="badge">kie.ai Â· Sora 2 Tools</div>
    <h1>Sora AI Toolkit</h1>
    <p class="subtitle">// Watermark Remover Â· Text to Video Â· Image to Video</p>
  </header>

  <!-- â”€â”€ API Key (shared) â”€â”€ -->
  <div class="panel">
    <div class="panel-title">à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² API</div>
    <div class="grid2">
      <div>
        <label>API Key</label>
        <input type="text" id="apiKey" placeholder="Bearer token à¸ˆà¸²à¸ kie.ai" />
      </div>
      <div>
        <label>Upload Method</label>
        <select id="uploadMethod">
          <option value="s3">s3 (à¸—à¸±à¹ˆà¸§à¹„à¸›)</option>
          <option value="oss">oss (à¸ˆà¸µà¸™ / Aliyun)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Tab switcher â”€â”€ -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('remove')">ğŸ§¹ Watermark Remover</button>
    <button class="tab" onclick="switchTab('txt2vid')">âœï¸ Text to Video</button>
    <button class="tab" onclick="switchTab('img2vid')">ğŸ–¼ï¸ Image to Video</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 1: Watermark Remover
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content active" id="tab-remove">
    <div class="panel">
      <div class="panel-title">à¹ƒà¸ªà¹ˆà¸¥à¸´à¸‡à¸à¹Œ Sora</div>
      <label>à¸£à¸¹à¸›à¹à¸šà¸š: <code style="font-family:JetBrains Mono,monospace;font-size:12px;background:rgba(124,58,237,.15);padding:2px 8px;border-radius:4px;color:#06b6d4;">à¸Šà¸·à¹ˆà¸­à¸„à¸¥à¸´à¸› | URL</code> â€” à¸šà¸£à¸£à¸—à¸±à¸”à¸¥à¸° 1 à¸£à¸²à¸¢à¸à¸²à¸£</label>
      <textarea id="removeUrls" rows="7" placeholder="à¸§à¸´à¸”à¸µà¹‚à¸­à¹à¸¡à¸§à¸™à¹ˆà¸²à¸£à¸±à¸ | https://sora.chatgpt.com/p/s_abc123...&#10;à¸—à¸°à¹€à¸¥à¸ªà¸µà¸Ÿà¹‰à¸² | https://sora.chatgpt.com/p/s_def456...&#10;https://sora.chatgpt.com/p/s_ghi789...  â† à¹„à¸¡à¹ˆà¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸à¹‡à¹„à¸”à¹‰"></textarea>
      <p class="hint">// à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­ à¸ˆà¸°à¹ƒà¸Šà¹‰ "à¸„à¸¥à¸´à¸› #1", "à¸„à¸¥à¸´à¸› #2" Â· à¸Šà¸·à¹ˆà¸­à¸ˆà¸°à¹ƒà¸Šà¹‰à¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¹„à¸Ÿà¸¥à¹Œà¸•à¸­à¸™à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”</p>
      <button class="btn-primary" onclick="startRemove()">âš¡ à¹€à¸£à¸´à¹ˆà¸¡à¸¥à¸šà¸¥à¸²à¸¢à¸™à¹‰à¸³à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 2: Text to Video
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-txt2vid">
    <div class="panel">
      <div class="panel-title">Text to Video</div>

      <label>à¸Šà¸·à¹ˆà¸­à¸„à¸¥à¸´à¸› (à¸ªà¸³à¸«à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ download)</label>
      <input type="text" id="t2v-name" placeholder="à¹€à¸Šà¹ˆà¸™ à¸§à¸´à¸”à¸µà¹‚à¸­à¹à¸¡à¸§" class="mt" style="margin-top:0;margin-bottom:16px;" />

      <label>Prompt (à¸šà¸£à¸£à¸¢à¸²à¸¢à¸§à¸´à¸”à¸µà¹‚à¸­à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£)</label>
      <textarea id="t2v-prompt" rows="5" placeholder="A cinematic shot of a golden retriever running on the beach at sunset..."></textarea>

      <div class="grid3 mt">
        <div>
          <label>Aspect Ratio</label>
          <select id="t2v-aspect">
            <option value="landscape">Landscape (16:9)</option>
            <option value="portrait">Portrait (9:16)</option>
          </select>
        </div>
        <div>
          <label>Duration</label>
          <select id="t2v-frames">
            <option value="10">10 à¸§à¸´à¸™à¸²à¸—à¸µ</option>
            <option value="15">15 à¸§à¸´à¸™à¸²à¸—à¸µ</option>
          </select>
        </div>
        <div>
          <label>Resolution</label>
          <select id="t2v-res">
            <option value="1080p">1080p</option>
            <option value="720p">720p</option>
            <option value="480p">480p</option>
          </select>
        </div>
      </div>

      <div class="toggle-row mt">
        <span class="toggle-label">à¸¥à¸š Watermark à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´</span>
        <label class="toggle">
          <input type="checkbox" id="t2v-nowm" checked />
          <span class="slider"></span>
        </label>
      </div>

      <button class="btn-primary" onclick="startTxt2Vid()">ğŸ¬ à¸ªà¸£à¹‰à¸²à¸‡à¸§à¸´à¸”à¸µà¹‚à¸­</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 3: Image to Video
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-img2vid">
    <div class="panel">
      <div class="panel-title">Image to Video</div>

      <label>à¸Šà¸·à¹ˆà¸­à¸„à¸¥à¸´à¸› (à¸ªà¸³à¸«à¸£à¸±à¸šà¹„à¸Ÿà¸¥à¹Œ download)</label>
      <input type="text" id="i2v-name" placeholder="à¹€à¸Šà¹ˆà¸™ à¸—à¸°à¹€à¸¥à¸ªà¸µà¸Ÿà¹‰à¸²" style="margin-bottom:16px;" />

      <label>à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸ (JPEG / PNG / WebP Â· max 10MB)</label>
      <div class="upload-zone" id="dropzone"
           ondragover="event.preventDefault(); this.classList.add('drag')"
           ondragleave="this.classList.remove('drag')"
           ondrop="handleDrop(event)">
        <input type="file" id="imageInput" accept="image/jpeg,image/png,image/webp" multiple onchange="handleFiles(this.files)" />
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">à¸¥à¸²à¸à¸§à¸²à¸‡à¸£à¸¹à¸›à¸—à¸µà¹ˆà¸™à¸µà¹ˆ à¸«à¸£à¸·à¸­ <span>à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸</span></div>
      </div>
      <div class="preview-grid" id="previewGrid"></div>

      <label class="mt" style="display:block;margin-top:16px;">Prompt (à¸šà¸£à¸£à¸¢à¸²à¸¢à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§)</label>
      <textarea id="i2v-prompt" rows="4" placeholder="The ocean waves gently crash, the sky transitions from blue to golden sunset..."></textarea>

      <div class="grid2 mt">
        <div>
          <label>Aspect Ratio</label>
          <select id="i2v-aspect">
            <option value="landscape">Landscape (16:9)</option>
            <option value="portrait">Portrait (9:16)</option>
          </select>
        </div>
        <div>
          <label>Duration</label>
          <select id="i2v-frames">
            <option value="10">10 à¸§à¸´à¸™à¸²à¸—à¸µ</option>
            <option value="15">15 à¸§à¸´à¸™à¸²à¸—à¸µ</option>
          </select>
        </div>
      </div>

      <div class="toggle-row mt">
        <span class="toggle-label">à¸¥à¸š Watermark à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´</span>
        <label class="toggle">
          <input type="checkbox" id="i2v-nowm" checked />
          <span class="slider"></span>
        </label>
      </div>

      <button class="btn-primary" onclick="startImg2Vid()">ğŸ¬ à¸ªà¸£à¹‰à¸²à¸‡à¸§à¸´à¸”à¸µà¹‚à¸­à¸ˆà¸²à¸à¸£à¸¹à¸›</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Results (shared)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="results-section">
    <div class="section-title">à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ</div>
    <div class="stats-bar">
      <div class="stat">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: <span id="st-total">0</span></div>
      <div class="stat s-done">âœ“ à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: <span id="st-done">0</span></div>
      <div class="stat s-run">âŸ³ à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥: <span id="st-run">0</span></div>
      <div class="stat s-fail">âœ• à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: <span id="st-fail">0</span></div>
    </div>
    <div id="jobs-list"></div>
  </div>

</div>

<script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const jobs = {};
let pollInterval = null;
let uploadedFiles = []; // base64 data URLs for image upload

// â”€â”€ Tab switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  event.currentTarget.classList.add('active');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function sanitize(name) {
  return name.replace(/[\/\\:*?"<>|]/g,'').trim() || 'video';
}

function getApiKey() { return document.getElementById('apiKey').value.trim(); }
function getUpload()  { return document.getElementById('uploadMethod').value; }

function resetJobs() {
  Object.keys(jobs).forEach(k => delete jobs[k]);
  document.getElementById('jobs-list').innerHTML = '';
  document.getElementById('results-section').style.display = 'block';
  updateStats();
}

// â”€â”€ Image upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleDrop(e) {
  e.preventDefault();
  document.getElementById('dropzone').classList.remove('drag');
  handleFiles(e.dataTransfer.files);
}

function handleFiles(files) {
  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      uploadedFiles.push({ dataUrl: reader.result, name: file.name, file });
      renderPreviews();
    };
    reader.readAsDataURL(file);
  });
}

function renderPreviews() {
  const grid = document.getElementById('previewGrid');
  grid.innerHTML = uploadedFiles.map((f, i) => `
    <div class="preview-item">
      <img src="${f.dataUrl}" />
      <button class="rm" onclick="removeFile(${i})">âœ•</button>
    </div>`).join('');
}

function removeFile(i) {
  uploadedFiles.splice(i, 1);
  renderPreviews();
}

// Upload image to kie.ai and get public URL
async function uploadImageToCloud(file, apiKey) {
  const formData = new FormData();
  formData.append('file', file);
  const res = await fetch('https://api.kie.ai/api/v1/files/upload', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + apiKey },
    body: formData
  });
  const data = await res.json();
  if (data.code === 200 && data.data?.url) return data.data.url;
  // fallback: use base64 data URL if upload fails
  throw new Error(data.msg || 'à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
}

// â”€â”€ â‘  Watermark Remover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseRemoveLines() {
  return document.getElementById('removeUrls').value
    .split('\n').map(l => l.trim()).filter(l => l)
    .map((line, idx) => {
      const pipe = line.indexOf('|');
      if (pipe > -1) {
        const name = line.slice(0, pipe).trim();
        const url  = line.slice(pipe + 1).trim();
        return { name: name || `à¸„à¸¥à¸´à¸› #${idx + 1}`, url };
      }
      return { name: `à¸„à¸¥à¸´à¸› #${idx + 1}`, url: line };
    });
}

async function startRemove() {
  const apiKey = getApiKey();
  const entries = parseRemoveLines();
  if (!apiKey)         return alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ API Key à¸à¹ˆà¸­à¸™');
  if (!entries.length) return alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸¥à¸´à¸‡à¸à¹Œà¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¸£à¸²à¸¢à¸à¸²à¸£');

  resetJobs();
  if (pollInterval) clearInterval(pollInterval);

  await Promise.allSettled(entries.map((e, i) =>
    submitJob(apiKey, {
      model: 'sora-watermark-remover',
      input: { video_url: e.url, upload_method: getUpload() }
    }, e.name, `ğŸ§¹ ${e.url}`, i + 1)
  ));

  updateStats();
  pollInterval = setInterval(() => pollAll(apiKey), 4000);
}

// â”€â”€ â‘¡ Text to Video â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startTxt2Vid() {
  const apiKey  = getApiKey();
  const prompt  = document.getElementById('t2v-prompt').value.trim();
  const name    = document.getElementById('t2v-name').value.trim() || 'Text-to-Video';
  const noWm    = document.getElementById('t2v-nowm').checked;

  if (!apiKey)  return alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ API Key à¸à¹ˆà¸­à¸™');
  if (!prompt)  return alert('à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆ Prompt à¸à¹ˆà¸­à¸™');

  resetJobs();
  if (pollInterval) clearInterval(pollInterval);

  await submitJob(apiKey, {
    model: 'sora-2',
    input: {
      prompt,
      aspect_ratio: document.getElementById('t2v-aspect').value,
      n_frames: document.getElementById('t2v-frames').value,
      resolution: document.getElementById('t2v-res').value,
      remove_watermark: noWm,
      upload_method: getUpload()
    }
  }, name, `âœï¸ ${prompt.slice(0, 80)}â€¦`, 1);

  updateStats();
  pollInterval = setInterval(() => pollAll(apiKey), 4000);
}

// â”€â”€ â‘¢ Image to Video â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startImg2Vid() {
  const apiKey = getApiKey();
  const prompt = document.getElementById('i2v-prompt').value.trim();
  const name   = document.getElementById('i2v-name').value.trim() || 'Image-to-Video';
  const noWm   = document.getElementById('i2v-nowm').checked;

  if (!apiKey)              return alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ API Key à¸à¹ˆà¸­à¸™');
  if (!uploadedFiles.length) return alert('à¸à¸£à¸¸à¸“à¸²à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸à¸à¹ˆà¸­à¸™');
  if (!prompt)              return alert('à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆ Prompt à¸à¹ˆà¸­à¸™');

  resetJobs();
  if (pollInterval) clearInterval(pollInterval);

  // Show uploading state
  const el = makeEl(1, name, 'ğŸ–¼ï¸ à¸à¸³à¸¥à¸±à¸‡à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›...', 'queued', null, null, null);
  document.getElementById('jobs-list').appendChild(el);
  jobs['job_1'] = { name, state: 'queued', el, taskId: null };

  try {
    // Upload all images and collect URLs
    const imageUrls = await Promise.all(
      uploadedFiles.map(f => uploadImageToCloud(f.file, apiKey))
    );

    await submitJobWithEl(apiKey, {
      model: 'sora-2-image-to-video',
      input: {
        prompt,
        image_urls: imageUrls,
        aspect_ratio: document.getElementById('i2v-aspect').value,
        n_frames: document.getElementById('i2v-frames').value,
        remove_watermark: noWm,
        upload_method: getUpload()
      }
    }, name, `ğŸ–¼ï¸ ${prompt.slice(0, 80)}â€¦`, 1, el);

  } catch(e) {
    jobs['job_1'].state = 'fail';
    el.className = 'job-item fail';
    fillEl(el, 1, name, `ğŸ–¼ï¸ ${prompt.slice(0,60)}`, 'fail', null, null, e.message);
  }

  updateStats();
  pollInterval = setInterval(() => pollAll(apiKey), 4000);
}

// â”€â”€ Core job submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitJob(apiKey, body, name, sub, idx) {
  const el = makeEl(idx, name, sub, 'queued', null, null, null);
  document.getElementById('jobs-list').appendChild(el);
  const jobId = 'job_' + idx;
  jobs[jobId] = { name, state: 'queued', el, taskId: null };
  await submitJobWithEl(apiKey, body, name, sub, idx, el, jobId);
}

async function submitJobWithEl(apiKey, body, name, sub, idx, el, jobId) {
  jobId = jobId || 'job_' + idx;
  if (!jobs[jobId]) jobs[jobId] = { name, state: 'queued', el, taskId: null };

  try {
    const res  = await fetch('https://api.kie.ai/api/v1/jobs/createTask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
      body: JSON.stringify(body)
    });
    const data = await res.json();

    if (data.code === 200 && data.data?.taskId) {
      jobs[jobId].taskId = data.data.taskId;
      jobs[jobId].state  = 'waiting';
      fillEl(el, idx, name, sub, 'waiting', data.data.taskId, null, null);
    } else {
      jobs[jobId].state = 'fail';
      el.className = 'job-item fail';
      fillEl(el, idx, name, sub, 'fail', null, null, data.msg || 'à¸ªà¸£à¹‰à¸²à¸‡ task à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
    }
  } catch(e) {
    jobs[jobId].state = 'fail';
    el.className = 'job-item fail';
    fillEl(el, idx, name, sub, 'fail', null, null, e.message);
  }
}

// â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollAll(apiKey) {
  const pending = Object.values(jobs).filter(j => j.state === 'waiting');
  if (!pending.length) { clearInterval(pollInterval); return; }
  await Promise.allSettled(pending.map(j => pollTask(apiKey, j)));
  updateStats();
}

async function pollTask(apiKey, job) {
  if (!job.taskId) return;
  try {
    const res  = await fetch(`https://api.kie.ai/api/v1/jobs/recordInfo?taskId=${job.taskId}`, {
      headers: { 'Authorization': 'Bearer ' + apiKey }
    });
    const data = await res.json();
    if (data.code !== 200 || !data.data) return;

    const t   = data.data;
    const idx = Object.values(jobs).indexOf(job) + 1;
    const sub = job.sub || '';

    if (t.state === 'success') {
      job.state = 'success';
      let resultUrl = null;
      try { resultUrl = JSON.parse(t.resultJson).resultUrls?.[0] || null; } catch {}
      job.el.className = 'job-item success';
      fillEl(job.el, idx, job.name, sub, 'success', job.taskId, resultUrl, null);
    } else if (t.state === 'fail') {
      job.state = 'fail';
      job.el.className = 'job-item fail';
      fillEl(job.el, idx, job.name, sub, 'fail', job.taskId, null, t.failMsg || 'à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§');
    }
  } catch {}
}

// â”€â”€ Blob download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function downloadBlob(btn, url, name) {
  btn.disabled = true;
  btn.textContent = 'âŸ³ à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...';
  const prog = btn.nextElementSibling;
  if (prog) prog.style.display = 'block';
  try {
    const res  = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();
    const bUrl = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = bUrl; a.download = sanitize(name) + '.mp4';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(bUrl);
    btn.textContent = 'âœ“ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹à¸¥à¹‰à¸§';
    if (prog) prog.style.display = 'none';
  } catch(e) {
    btn.disabled = false;
    btn.textContent = 'â–¼ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” Â· ' + name + '.mp4';
    if (prog) { prog.textContent = 'âš  ' + e.message; }
  }
}

// â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makeEl(idx, name, sub, state, taskId, resultUrl, errMsg) {
  const el = document.createElement('div');
  el.className = 'job-item';
  fillEl(el, idx, name, sub, state, taskId, resultUrl, errMsg);
  return el;
}

function fillEl(el, idx, name, sub, state, taskId, resultUrl, errMsg) {
  const labels = { queued:'à¸£à¸­à¸ªà¸£à¹‰à¸²à¸‡ task...', waiting:'à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥...', success:'à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!', fail:'à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§' };
  el.innerHTML = `
    <div class="job-num">${String(idx).padStart(2,'0')}</div>
    <div class="job-info">
      <div class="job-name">${esc(name)}</div>
      <div class="job-sub">${esc(sub)}</div>
      <div class="job-status">
        <span class="dot ${state === 'queued' ? 'queued' : state}"></span>
        ${labels[state] || state}
      </div>
      ${taskId ? `<div class="task-id">task id: ${taskId}</div>` : ''}
      ${errMsg ? `<div class="error-msg">âš  ${esc(errMsg)}</div>` : ''}
      ${resultUrl ? `
        <button class="btn-download" onclick="downloadBlob(this,'${esc(resultUrl)}','${esc(name)}')">
          â–¼ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” Â· ${esc(name)}.mp4
        </button>
        <div class="dl-progress" style="display:none;">âŸ³ à¸à¸³à¸¥à¸±à¸‡à¸”à¸¶à¸‡à¹„à¸Ÿà¸¥à¹Œ...</div>` : ''}
    </div>`;
}

function updateStats() {
  const all = Object.values(jobs);
  document.getElementById('st-total').textContent = all.length;
  document.getElementById('st-done').textContent  = all.filter(j=>j.state==='success').length;
  document.getElementById('st-run').textContent   = all.filter(j=>j.state==='waiting'||j.state==='queued').length;
  document.getElementById('st-fail').textContent  = all.filter(j=>j.state==='fail').length;
}
</script>
</body>
</html>
